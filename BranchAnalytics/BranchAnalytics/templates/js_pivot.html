<!doctype html>
{% load static %}
{% load humanize %}
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Profit & Loss</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- inject:css-->

	  <link rel="stylesheet" type="text/css" href="{% static 'assets/d3site/dc.css' %}"/>

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/bootstrap/bootstrap.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/daterangepicker.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/fontawesome.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/footable.standalone.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/fullcalendar@5.2.0.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/jquery-jvectormap-2.0.5.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/jquery.mCustomScrollbar.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/leaflet.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/line-awesome.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/magnific-popup.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/MarkerCluster.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/MarkerCluster.Default.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/select2.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/slick.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/star-rating-svg.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/trumbowyg.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/wickedpicker.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/style.css' %}">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.12.0/clusterize.css">

    <style>


     .context-menu {
       position: absolute;
     }
     .menu {
       display: flex;
       flex-direction: column;
       background-color: #fff;
       border-radius: 10px;
       box-shadow: 0 10px 20px rgb(64 64 64 / 5%);
       padding: 10px 0;
     }
     .menu > li > a {
       font: inherit;
       border: 0;
       padding: 10px 30px 10px 15px;
       width: 100%;
       display: flex;
       align-items: center;
       position: relative;
       text-decoration: unset;
       color: #616161;
       font-weight: normal;
       transition: 0.3s linear;
       -webkit-transition: 0.3s linear;
       -moz-transition: 0.3s linear;
       -ms-transition: 0.3s linear;
       -o-transition: 0.3s linear;
     }
     .menu > li > a:hover {
       background:#f1f3f7;
       color: #ff0000;
     }
     .menu > li > a > i {
       padding-right: 10px;
     }
     .menu > li.trash > a:hover {
       color: red;
     }

     .centerrow {
       text-align: center;
       vertical-align: middle;
     }

     .tablesize th {
         position: relative;
     }

     #resizeMe.hide2 tr > *:nth-child(7) {
         display: none;
     }


     .resizer {
         /* Displayed at the right side of column */
         position: absolute;
         top: 0;
         right: 0;
         width: 5px;
         cursor: col-resize;
         user-select: none;
     }

     .negval{
       color: white;
       background-color: rgba(255, 20, 20,.7);
     }

     .greenval{
       color: black;
       background-color: rgba(20, 255, 94,.5);
     }

     tr:hover {background-color: rgba(91, 108, 133, .1);}

     .cart { width: 100%; }

     .hasTooltip div {
         display: none;
         color: #000;
         text-decoration: none;
         padding: 3px;
     }

     .hasTooltip:hover div {
         display: block;
         position: absolute;
         left: 50px;
         background-color: #ffffff;

     }

     #headers td {
       color:black;
       font-weight:bold;
       border-bottom: 2px solid gray;

     }

     .subtotals-line {
       color:red;
       font-weight:bold;
     }

     .subtotals-dims {
       color:#383838;
       font-weight:bold;
     }

     .expand {
       font-weight:bold;
     }


    </style>

    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/favicon.png' %}">
</head>

<body class="layout-light side-menu overlayScroll">



    <div class="Branch STK-search"></div>

    <div class="Branch STK-author-actions"></div>
    <header class="header-top">
        {% include 'navbar.html' %}
    </header>
    <main class="main-content" id ='main_fade'>
      <aside class="sidebar" id='main_sidebar_id' style='margin-top:15px;'>
          <div class="sidebar__menu-group">
              <ul class="sidebar_nav">
                  <li class="menu-title">
                      <span>Group</span>
                  </li>
                  <li class="has-child open">
                      <a href="#" class="active">
                        <select id='group_filter' name='group_filter'>
                          <option value='starter' id='group_filter_default'>Select All</option>
                          {% for g in group_labels %}
                          <option value='{{g}}'>{{g}}</option>
                          {% endfor %}
                        </select>
                      </a>
                  </li>

                  <br>
                  <li class="menu-title">
                      <span>Branch</span>
                  </li>
                  <li class="has-child open">
                      <a href="#" class="active">
                        <select id='branch_filter'>
                          <option value='starter' id='customer_filter_default'>Select All</option>
                          {% for g in branch_labels %}
                          <option value='{{g}}'>{{g}}</option>
                          {% endfor %}
                        </select>
                      </a>
                  </li>

                  <br>
                  <li class="menu-title">
                      <span>Period</span>
                  </li>
                  <li class="has-child open">
                      <a href="#" class="active">
                        <select id='month_filter'>
                          <option value='starter' id='month_filter_default'>Select All</option>
                          {% for g in month_labels %}
                          <option value='{{g}}'>{{g}}</option>
                          {% endfor %}
                        </select>
                      </a>
                  </li>

                  <br>
                  <li class="menu-title">
                      <span>Conditional Formatting</span>
                  </li>
                  <li class="has-child open">
                      <a href="#" class="active">
                        <select id='format_selection'>
                          <option value='0' id='format_selection_default'>Off</option>
                          <option value='1'>On</option>
                        </select>
                      </a>
                  </li>

              </ul>


          </div>
      </aside>

        <div class="contents">
            <div class="container-fluid"><br>


                <div class="row">

                  <div class="col-xxl-12 mb-25">

                      <div class="card border-0">
                          <div class="card-header">
                              <h6>P&L</h6>
                              <div class="card-extra">
                                  <div class="card-tab btn-group atbd-button-group mr-3 nav nav-tabs">
                                      <a class="btn btn-xs btn-white active border" data-toggle="tab" href='#' href='#' onclick='javascript:resetTable();' role="tab" area-controls="st_matrics" aria-selected="true">Level 1</a>
                                      <a class="btn btn-xs btn-white border" data-toggle="tab" href='#' role="tab" onclick='javascript:activateLevel(2);' aria-selected="false">Level 2</a>
                                      <a class="btn btn-xs btn-white border" data-toggle="tab" href="#" role="tab" onclick='javascript:activateLevel(3);' aria-selected="false">Level 3</a>
                                      <a class="btn btn-xs btn-white border" data-toggle="tab" href="#" role="tab" onclick='javascript:activateLevel(4);' aria-selected="false">Level 4</a>
                                  </div>
                                  <div class="dropdown dropleft">
                                      <a href="#" role="button" id="Today" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                          <span data-feather="more-horizontal"></span>
                                      </a>
                                      <div class="dropdown-menu" aria-labelledby="Today">
                                          <a class="dropdown-item" href="javascript:exportTableToExcel();">Export</a>
                                          <div class="dropdown-divider"></div>
                                          <a class="dropdown-item" href="#" onclick='javascript:resetTable();'>Collapse All</a>
                                          <a class="dropdown-item" href="#" onclick='javascript:activateLevel(4);'>Expand All</a>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="card-body p-0">
                              <div class="tab-content">
                                  <div class="tab-pane fade active show" id="st_matrics-today" role="" aria-labelledby="st_matrics-tab">
                                      <div class="table-responsive" style='padding-left: 25px; padding-right: 25px;'>
                                        <table id = 'main_table' class="table table-bordered tablesize" style='font-size: .85em;'>
                                          <thead>
                                            <tr>
                                              <th scope="col" ></th>
                                              <th scope="col" >Line</th>
                                              <th scope="col" >Aug-21</th>
                                              <th scope="col" >Aug-20</th>
                                              <th scope="col" >Variance</th>
                                              <th scope="col" >YTD 21</th>
                                              <th scope="col" >YTD 20</th>
                                              <th scope="col" >Variance</th>
                                              <th scope="col" >Trend</th>
                                            </tr>
                                          </thead>
                                          <tbody id='main_tbody' class='tbody_main'>
                                          </tbody>
                                        </table>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                  </div>


              </div>
              <br>

          </div>

          </div>
        </div>

      <div class="row"><br><br><br><br><br><br><div>

    </div>

  </div>

  <footer class="footer-wrapper">
      <div class="container-fluid">
          <div class="row">
              <div class="col-md-6">
                  <div class="footer-copyright">
                      <p><a href="#">Created by Josh Floyd</a>
                      </p>
                  </div>
              </div>
              <div class="col-md-6">
                  <div class="footer-menu text-right">
                      <ul>
                          <li>
                              <a href="#">About</a>
                          </li>
                          <li>
                              <a href="#">Contact</a>
                          </li>
                      </ul>
                  </div>
                  <!-- ends: .Footer Menu -->
              </div>
          </div>
      </div>
  </footer>
    </main>

    <div id="contextMenu" class="context-menu" style="display: none">
        <ul class="menu" >
            <li class="share"><a href="javascript:userSaveBookmark();"><i class="fa fa-share" aria-hidden="true"></i> Save Bookmark</a></li>
            <li class="link"><a href="#"><i class="fa fa-link" aria-hidden="true"></i> View Bookmarks</a></li>
            <li class="copy"><a href="#"><i class="fa fa-copy" aria-hidden="true"></i> Add Comment</a></li>
            <li class="paste"><a href="#"><i class="fa fa-paste" aria-hidden="true"></i> View Comments</a></li>
            <li class="download"><a href="#"><i class="fa fa-download" aria-hidden="true"></i> Screenshot</a></li>
        </ul>
    </div>


    <div id="overlayer">
        <span class="loader-overlay">
            <div class="atbd-spin-dots spin-lg">
                <span class="spin-dot badge-dot dot-primary"></span>
                <span class="spin-dot badge-dot dot-primary"></span>
                <span class="spin-dot badge-dot dot-primary"></span>
                <span class="spin-dot badge-dot dot-primary"></span>
            </div>
        </span>
    </div>


    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDduF2tLXicDEPDMAtC6-NLOekX0A5vlnY"></script>
    <!-- inject:js-->
    <script src="{% static 'assets/vendor_assets/js/jquery/jquery-3.5.1.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery/jquery-ui.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/bootstrap/popper.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/bootstrap/bootstrap.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/moment/moment.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/accordion.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/autoComplete.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/Chart.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/charts.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/daterangepicker.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/drawer.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/dynamicBadge.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/dynamicCheckbox.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/feather.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/footable.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/fullcalendar@5.2.0.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/google-chart.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery-jvectormap-2.0.5.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery-jvectormap-world-mill-en.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.countdown.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.filterizr.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.magnific-popup.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.mCustomScrollbar.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.peity.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.star-rating-svg.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/leaflet.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/leaflet.markercluster.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/loader.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/message.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/moment.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/muuri.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/notification.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/popover.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/select2.full.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/slick.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/trumbowyg.base64.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/trumbowyg.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/wickedpicker.min.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/drag-drop.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/footable.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/full-calendar.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/googlemap-init.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/icon-loader.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/jvectormap-init.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/leaflet-init.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/main.js' %}"></script>


    <script type="text/javascript" src="{% static 'assets/d3site/d3.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/crossfilter.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/dc.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/axis.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/margin-mixin.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/cap-mixin.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/dc.datatables.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>

    <!-- Resources -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>




<script type="text/javascript">


    //Selectors
    var group_select = ['starter'];
    var branch_select = ['starter'];
    var month_select = ['starter'];

    //Labels
    var group_labels = {{group_labels|safe}};
    var branch_labels = {{branch_labels|safe}};
    var month_labels = {{month_labels|safe}};

    //Data
    var responseData = null;
    var waterfallChart = null;

    var spark1 = null;
    var spark2 = null;
    var spark3 = null;
    var spark4 = null;

    var applyFormatting = 0;

    function clearAllSelections(){
      $('#group_filter').val('starter');
      $('#group_filter').trigger('change');
      $('#branch_filter').val('starter');
      $('#branch_filter').trigger('change');
      $('#month_filter').val('starter');
      $('#month_filter').trigger('change');
    };

    function clearAllandRefresh(){
      $('#group_filter').val('starter');
      $('#group_filter').trigger('change');
      $('#branch_filter').val('starter');
      $('#branch_filter').trigger('change');
      $('#month_filter').val('starter');
      $('#month_filter').trigger('change');
      industry_select = ['starter'];

      updateDataAll();
      redrawCanvas();
      rebuildCharts();
      updateLabels();
      updateFilters2();
    };


  function updateLabels(){
  };

  function updateFilters2(){
  };

  function updateDataAll(){

    $.ajax({
        url: '{% url "gather_data_gl" %}',
        data: {

          //Filters
          'group_select': group_select,
          'branch_select': branch_select,
          'month_select':month_select,

        },

        dataType: 'json',
          success: function (data) {
              if (data.is_taken) {

                  table_data = data.main_data

                  //select labels
                  responseData = data
                  updateLabels();
                  updateFilters2();

                  pl_line1 = data.pl_line1;
                  pl_line2 = data.pl_line2;
                  waterfall = pl_line1;
                  waterfall2 = pl_line2;
                  pl_gross_profit = data.pl_gross_profit;
                  pl_net_profit = data.pl_net_profit;

                  updateTable();
                  waterfallChart.data = updateWaterfall();

                  colorCells();

              }
          }
    });
};


$(document).ready(function(){
  // Initialize select2
  $("#group_filter").select2();
  $("#branch_filter").select2();
  $("#month_filter").select2();
  $("#format_selection").select2();
});


//Listeners
$("#group_filter").change(function () {
  group_select = $("#group_filter").val();
  updateDataAll();
});

$("#branch_filter").change(function () {
  branch_select = $("#branch_filter").val();
  updateDataAll();
});

$("#month_filter").change(function () {
  month_select = $("#month_filter").val();
  updateDataAll();
});

$("#format_selection").change(function () {
  applyFormatting = $("#format_selection").val();
  resetTable();
});

</script>

<script>

  //Context Menu
   document.onclick = hideMenu;
   document.oncontextmenu = rightClick;

    function hideMenu() {
        document.getElementById("contextMenu").style.display = "none"
        $("#main_fade").fadeTo("fast", 1);
    }

    function rightClick(e) {
    $("#main_fade").fadeTo("slow", 0.4);


        e.preventDefault();

        if (document.getElementById("contextMenu") .style.display == "block"){
            hideMenu();

        }else{
            var menu = document.getElementById("contextMenu")
            menu.style.display = 'block';
            menu.style.left = e.pageX + "px";
            menu.style.top = e.pageY + "px";
        }

  }

function slugify(text)
{
  return text.toString()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-\-+/g, '-')
    .replace(/^-+/, '')
    .replace(/-+$/, '');
};

function userSaveBookmark(){
  console.log('Called');
  $.ajax({
      url: '{% url "save_bookmark" %}',
      data: {

        //Filters
        'group_select': group_select,
        'branch_select': branch_select,
        'month_select':month_select,
        'page': 'ledger',

      },

      dataType: 'json',
        success: function (data) {
            if (data.success == 1) {
              Swal.fire({
                icon: 'success',
                title: 'Saved',
                text: 'Bookmark Saved Successfully',
                confirmButtonColor: '#00c247',
              });
            } else {
              Swal.fire({
                icon: 'danger',
                title: 'Failed',
                text: 'Bookmark Save Failed',
                confirmButtonColor: '#db291d',
              });
            }
        }
  })
};


var formatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  maximumFractionDigits: 0
});


  var sel_multi = 1;

  // Create our number formatter.
  var formatter = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    maximumFractionDigits: 0,
  });


  function multi_amt(amount, perc){
    amount = parseInt(amount)
    amount = Math.round(amount);
    if (perc == 1){
      amount = amount.toString() +'%';
    } else {
      amount = formatter.format(amount).toString();
    }
    return amount
  }

  function grp_select_change(){
    sel_multi = document.getElementById('group_select').value;
    resetTable();
  };


    //Resizable Columns - //
    const table = document.getElementById('main_table');

    // Query all headers
    cols = table.querySelectorAll('th');

    // Loop over them
    [].forEach.call(cols, function(col) {
        // Create a resizer element
        const resizer = document.createElement('div');
        resizer.classList.add('resizer');

        // Set the height
        resizer.style.height = `${table.offsetHeight}px`;

        // Add a resizer element to the column
        col.appendChild(resizer);

        // Will be implemented in the next section
        createResizableColumn(col, resizer);
    });

    function createResizableColumn (col, resizer) {
        // Track the current position of mouse
        let x = 0;
        let w = 0;

        const mouseDownHandler = function(e) {
            // Get the current mouse position
            x = e.clientX;

            // Calculate the current width of column
            const styles = window.getComputedStyle(col);
            w = parseInt(styles.width, 10);

            // Attach listeners for document's events
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
        };

        const mouseMoveHandler = function(e) {
            // Determine how far the mouse has been moved
            const dx = e.clientX - x;

            // Update the width of column
            col.style.width = `${w + dx}px`;
        };

        // When user releases the mouse, remove the existing event listeners
        const mouseUpHandler = function() {
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
        };

        resizer.addEventListener('mousedown', mouseDownHandler);
    };

    //Data //

    var table_data = [
      {'Level': '1', 'HasChildren':1, 'ParentNode': 0, 'subTotal':0, 'Line': 'Sales', 'Amount': '650', 'PriorYear': '500'},
        {'Level': '2', 'HasChildren':1, 'ParentNode': 'Sales', 'subTotal':0, 'Line': 'Merchandise Sales', 'Amount': '310', 'PriorYear': '550'},
          {'Level': '3', 'HasChildren':0, 'ParentNode': 'Merchandise Sales', 'subTotal':0, 'Line': '1001 - Store Revenue ', 'Amount': '100', 'PriorYear': '90'},
          {'Level': '3', 'HasChildren':0, 'ParentNode': 'Merchandise Sales', 'subTotal':0, 'Line': '1002 - Online Revenue ', 'Amount': '100', 'PriorYear': '90'},
        {'Level': '2', 'HasChildren':1, 'ParentNode': 'Sales', 'subTotal':0, 'Line': 'Other Revenue', 'Amount': '200', 'PriorYear': '250'},
          {'Level': '3', 'HasChildren':0, 'ParentNode': 'Other Revenue', 'subTotal':0, 'Line': '1003 - Misc Revenue', 'Amount': '200', 'PriorYear': '250'},

      {'Level': '1', 'HasChildren':1, 'ParentNode': 0, 'subTotal':0, 'Line': 'COGS', 'Amount': '150', 'PriorYear': '145'},
        {'Level': '2', 'HasChildren':1, 'ParentNode': 'COGS', 'subTotal':0, 'Line': 'Product Cost', 'Amount': '150', 'PriorYear': '145'},
          {'Level': '3', 'HasChildren':0, 'ParentNode': 'Product Cost', 'subTotal':0, 'Line': '2001 - COGS', 'Amount': '150', 'PriorYear': '145'},

        {'Level': '2', 'HasChildren':1, 'ParentNode': 'COGS', 'subTotal':0, 'Line': 'Other Cost', 'Amount': '150', 'PriorYear': '145'},
        {'Level': '3', 'HasChildren':0, 'ParentNode': 'Other Cost', 'subTotal':0, 'Line': '2002 - Misc COGS', 'Amount': '150', 'PriorYear': '145'},

      {'Level': '1', 'HasChildren':0, 'ParentNode': 0, 'subTotal':1, 'Line': 'Gross Profit', 'Amount': '100', 'PriorYear': '95'},

      {'Level': '1', 'HasChildren':1, 'ParentNode': 0, 'subTotal':0, 'Line': 'Operating Expense', 'Amount': '500', 'PriorYear': '496'},
        {'Level': '2', 'HasChildren':1, 'ParentNode': 'Operating Expense', 'subTotal':0, 'Line': 'Salaries & Wages', 'Amount': '150', 'PriorYear': '145'},
          {'Level': '3', 'HasChildren':1, 'ParentNode': 'Salaries & Wages', 'subTotal':0, 'Line': 'Salaries', 'Amount': '150', 'PriorYear': '145'},
            {'Level': '4', 'HasChildren':0, 'ParentNode': 'Salaries', 'subTotal':0, 'Line': '3001 - Salaries', 'Amount': '150', 'PriorYear': '145'},
          {'Level': '3', 'HasChildren':1, 'ParentNode': 'Salaries & Wages', 'subTotal':0, 'Line': 'Commissions', 'Amount': '150', 'PriorYear': '145'},
            {'Level': '4', 'HasChildren':0, 'ParentNode': 'Commissions', 'subTotal':0, 'Line': '3002 - Commissions', 'Amount': '150', 'PriorYear': '145'},
          {'Level': '3', 'HasChildren':1, 'ParentNode': 'Salaries & Wages', 'subTotal':0, 'Line': 'Other Wages', 'Amount': '150', 'PriorYear': '145'},
            {'Level': '4', 'HasChildren':0, 'ParentNode': 'Other Wages', 'subTotal':0, 'Line': '3003 - Other Wages', 'Amount': '150', 'PriorYear': '145'},

      {'Level': '1', 'HasChildren':1, 'ParentNode': 0, 'subTotal':0, 'Line': 'Other Inc/Exp', 'Amount': '500', 'PriorYear': '496'},
        {'Level': '2', 'HasChildren':1, 'ParentNode': 'Other Inc/Exp', 'subTotal':0, 'Line': 'Other Income', 'Amount': '150', 'PriorYear': '145'},
          {'Level': '3', 'HasChildren':0, 'ParentNode': 'Other Income', 'subTotal':0, 'Line': '4001 - Misc Income', 'Amount': '150', 'PriorYear': '145'},
        {'Level': '2', 'HasChildren':1, 'ParentNode': 'Other Inc/Exp', 'subTotal':0, 'Line': 'Other Expenses', 'Amount': '150', 'PriorYear': '145'},
          {'Level': '3', 'HasChildren':0, 'ParentNode': 'Other Expenses', 'subTotal':0, 'Line': '4002 - Misc Expenses', 'Amount': '150', 'PriorYear': '145'},

      {'Level': '1', 'HasChildren':0, 'ParentNode': 0, 'subTotal':1, 'Line': 'Net Income', 'Amount': '100', 'PriorYear': '95'},

    ];


    // User Selection for Conditional Formatting - JF //
    var sales_format = table_data[0].Amount;


    function resetID(){
      var i = 1;
      for (line of table_data){
        line.ID = i;
        i += 1;
      }
    }

    function amtFormatting(cal_perc){
      var set_class = '';
      if (applyFormatting == '1'){
        if (cal_perc < -15 ){
          set_class = 'negval';
        } else if (cal_perc > 15){
          set_class = 'greenval';
        } else {};
      };
      return set_class;
    }

    // Level spacing for levels > 1 //
    function levelSpacing(level, linestr, haschildren, expand){
      i = 0
      var str = linestr
      var parent = document.createElement('td');
      if (haschildren == 1 ){
        if(expand == 1){
          parent.innerHTML = '<b>-</b>'
        } else {
          parent.innerHTML = '<b>+</b>'
        }
      }
      while (i <= level){
        parent.append("\u00A0");
        parent.append("\u00A0");
        parent.append("\u00A0");
        i += 1;
      }
      parent.append(linestr);
      return parent;
    };


    //Build all Level 1's for initaal table - JF //
    function initalTable(){
      var row_index = 0;
      var main_tbody = document.getElementById('main_tbody');

      for (line of table_data){

        //Just Level 1 Rows for the Inital Data
        if (line.Level == '1'){

            //Create new Row
            var new_tr = main_tbody.insertRow(row_index);
            new_tr.id = line.ID;


            //Collapsed or Expanded State
            if(line.HasChildren == 1){new_tr.className = 'collapsed'};

            //Expandable if has children
            if(line.HasChildren == 1){new_tr.setAttribute("onclick","expandNode(" + "'" + line.Line + "'" + ");")};

            //Table Dimensions
            var ntd = document.createElement('td');
            if (line.HasChildren == 1){ntd.innerHTML = '<b>+</b>';} else {ntd.innerHTML = '';};

            ntd.id = line.ID + 'ftd';
            new_tr.appendChild(ntd);

            if (line.Level == 1){
            var ntd = document.createElement('td');
            ntd.id = line.ID + 'fline';
            ntd.innerHTML = line.Line;
            //Row Formatting & Attributes
            if(line.subTotal == 1){ntd.className = 'subtotals-line'};
            new_tr.appendChild(ntd);
            } else {
             var ntd = levelSpacing(line.Level, line.Line, line.HasChildren, 0)
             ntd.id = line.ID + 'fline';
             //Row Formatting & Attributes
             if(line.subTotal == 1){ntd.className = 'subtotals-line'};
             new_tr.appendChild(ntd);
            }

            var ntd = document.createElement('td');
            ntd.innerHTML = multi_amt(line.Amount);
            ntd.id = 'amt_1' + line.ID;
            if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
            new_tr.appendChild(ntd);
            formatPercentSales(ntd.id, line.subTotal, (line.Amount / sales_format)*100);

            var ntd = document.createElement('td');
            ntd.innerHTML =  multi_amt(line.PriorYear);
            ntd.id = 'amt_2' + line.ID;
            if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
            new_tr.appendChild(ntd);

            var ntd = document.createElement('td');
            var cal_amt = line.Amount - line.PriorYear;
            var cal_perc = (((line.Amount*8) - (line.PriorYear*8))/(line.PriorYear*8))*100;
            ntd.className = amtFormatting(cal_perc);
            ntd.innerHTML =  multi_amt(cal_amt) + ' (' + multi_amt(cal_perc,1) + ')';
            ntd.id = 'amt_3' + line.ID;
            if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
            new_tr.appendChild(ntd);

            var ntd = document.createElement('td');
            ntd.innerHTML =  multi_amt(line.Amount * 8);
            ntd.id = 'amt_4' + line.ID;
            new_tr.appendChild(ntd);

            var ntd = document.createElement('td');
            ntd.innerHTML =  multi_amt(line.PriorYear * 8);
            ntd.id = 'amt_5' + line.ID;
            if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
            new_tr.appendChild(ntd);

            var ntd = document.createElement('td');
            var cal_amt = (line.Amount*8) - (line.PriorYear*8);
            var cal_perc = (((line.Amount*8) - (line.PriorYear*8))/(line.PriorYear*8))*100;
            ntd.className = amtFormatting(cal_perc);
            ntd.innerHTML =  multi_amt(cal_amt) + ' (' + multi_amt(cal_perc,1) + ')';
            ntd.id = 'amt_6' + line.ID;
            if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
            new_tr.appendChild(ntd);


            var ntd = document.createElement('td');
            ntd.id = 'spk' + line.ID;
            ntd.width = '100px';
            new_tr.appendChild(ntd);
            buildTrend(ntd.id);

            row_index = row_index + 1;

        }
      }
    }

    // Expand Nodes - JF //
    function expandNode(parent_node){
      var main_tbody = document.getElementById('main_tbody');

      for (line of table_data){
        if (line.Line == parent_node){
          var parent_obj = line
        }
      };

      var parent_element = document.getElementById(parent_obj.ID);
      var row_index = parent_element.rowIndex;

      //Check to make sure its not already expanded
      if (parent_element.className != 'expanded'){
      parent_element.className = 'expanded';

      if (parent_obj.Level == 1){
        document.getElementById(parent_element.id + 'ftd').innerHTML = '<b>-</b>';
      } else {
          document.getElementById(parent_obj.ID + 'fline').innerHTML = levelSpacing(parent_obj.Level, parent_obj.Line, parent_obj.HasChildren, 1).innerHTML;
      }

      parent_element.setAttribute("onclick","collapseNode(" + "'" + parent_obj.Line + "'" + ");");


      for (line of table_data){
        if (line.ParentNode == parent_node){
          var new_tr = main_tbody.insertRow(row_index);
          new_tr.id = line.ID;

          //Row Formatting & Attributes
          if(line.subTotal == 1){new_tr.className = 'subtotals'};

          //Collapsed or Expanded State
          if(line.HasChildren == 1){new_tr.className = 'collapsed'};

          //Expandable if has children
          if(line.HasChildren == 1){new_tr.setAttribute("onclick","expandNode(" + "'" + line.Line + "'" + ");")};

          //Table Dimensions
          var ntd = document.createElement('td');

          ntd.id = line.ID + 'ftd';
          new_tr.appendChild(ntd);

          if (line.Level == 1){
          var ntd = document.createElement('td');
          ntd.innerHTML = line.Line;
          if(line.subTotal == 1){ntd.className = 'subtotals-line'};
          ntd.id = line.ID + 'fline';
          new_tr.appendChild(ntd);
          } else {
           var ntd = levelSpacing(line.Level, line.Line, line.HasChildren, 0)
           ntd.id = line.ID + 'fline';
           if(line.subTotal == 1){ntd.className = 'subtotals-line'};
           new_tr.appendChild(ntd);
          }

          var ntd = document.createElement('td');
          ntd.innerHTML = multi_amt(line.Amount);
          ntd.id = 'amt_1' + line.ID;
          if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
          new_tr.appendChild(ntd);
          formatPercentSales(ntd.id, line.subTotal,(line.Amount / sales_format)*100);

          var ntd = document.createElement('td');
          ntd.innerHTML = multi_amt(line.PriorYear);
          ntd.id = 'amt_2' + line.ID;
          if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
          new_tr.appendChild(ntd);

          var ntd = document.createElement('td');
          var cal_amt = line.Amount - line.PriorYear;
          var cal_perc = (((line.Amount*8) - (line.PriorYear*8))/(line.PriorYear*8))*100;
          ntd.className = amtFormatting(cal_perc);
          ntd.innerHTML =  multi_amt(cal_amt) + ' (' + multi_amt(cal_perc,1) + ')';
          ntd.id = 'amt_3' + line.ID;
          if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
          new_tr.appendChild(ntd);


          var ntd = document.createElement('td');
          ntd.innerHTML =  multi_amt(line.Amount * 8);
          ntd.id = 'amt_4' + line.ID;
          if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
          new_tr.appendChild(ntd);

          var ntd = document.createElement('td');
          ntd.innerHTML =  multi_amt(line.PriorYear * 8);
          ntd.id = 'amt_5' + line.ID;
          if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
          new_tr.appendChild(ntd);

          var ntd = document.createElement('td');
          var cal_amt = (line.Amount*8) - (line.PriorYear*8);
          var cal_perc = (((line.Amount*8) - (line.PriorYear*8))/(line.PriorYear*8))*100;
          ntd.className = amtFormatting(cal_perc);
          ntd.innerHTML =  multi_amt(cal_amt) + ' (' + multi_amt(cal_perc,1) + ')';
          ntd.id = 'amt_6' + line.ID;
          if(line.subTotal == 1){ntd.className = 'subtotals-dims'};
          new_tr.appendChild(ntd);

          var ntd = document.createElement('td');
          ntd.id = 'spk' + line.ID;
          ntd.width = '100px';
          new_tr.appendChild(ntd);
          buildTrend(ntd.id);


          row_index = row_index + 1;

          }
        }
      }
    };

    // Collapse Nodes - JF //
    function collapseNode(parent_node){
      getChildren(parent_node);

      //Parent ELement Formatting
      for (line of table_data){
        if (line.Line == parent_node){
          var parent_obj = line
        }
      };

      var parent_element = document.getElementById(parent_obj.ID);

      parent_element.className = 'collapsed';

      // Format + / - based on Child Attribute, if none pass to level spacing function //
      if (parent_obj.Level == 1){
        document.getElementById(parent_element.id + 'ftd').innerHTML = '<b>+</b>';
      } else {
        document.getElementById(parent_obj.ID + 'fline').innerHTML = levelSpacing(parent_obj.Level, parent_obj.Line, parent_obj.HasChildren, 0).innerHTML;
      }
      parent_element.setAttribute("onclick","expandNode(" + "'" + parent_obj.Line + "'" + ");");
  };


  // Get Children of Parent Node, If none then delete - JF //
  function getChildren(parent_node, selfdestroy){
    //Starting Parent Node
    var parent_element = document.getElementById(parent_node);

    //Iterate in search of children
    for (line of table_data){
      if (line.ParentNode == parent_node){
        if (line.HasChildren == 1){

          //If found, look further for more children
          getChildren(line.Line, 1);
        } else {
          //No more found, destroy child
          removeElement(line.ID);
        }
      }
    }

    //If this is a follow and not the inital, destroy element after its recusrive search
    if (selfdestroy == 1){
      for (line of table_data){
        if (line.Line == parent_node){
          var parent_obj = line
        }
      }
      removeElement(parent_obj.ID);
      }
  };

  // Delete element from DOM - JF //
  function removeElement(element){
    try {
      var ele = document.getElementById(element)
      ele.remove();
    } catch(err){
    }
  }

  // Export Capabilities - JF //
  function exportTableToExcel(){
      filename = 'dataexport'
      var downloadLink;
      var dataType = 'application/vnd.ms-excel';
      var tableSelect = document.getElementById('main_table');
      var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
      filename = filename?filename+'.xls':'excel_data.xlsx';
      downloadLink = document.createElement("a");
      document.body.appendChild(downloadLink);
      if(navigator.msSaveOrOpenBlob){
          var blob = new Blob(['\ufeff', tableHTML], {
              type: dataType
          });
          navigator.msSaveOrOpenBlob( blob, filename);
      } else {
          downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
          downloadLink.download = filename;
          downloadLink.click();
      }
  }

  // Format Amount Column - JF 9/27 //
  function formatPercentSales(element, subtotal, percentage){
     if (subtotal != 1){
      var col1="rgba(0, 224, 67, .08)";
      var col2="#ffF";
      var els = document.getElementById(element);
      var percentage = percentage;
      els.style.background="-webkit-gradient(linear, left top,right top, color-stop("+percentage+"%,"+col1+"), color-stop("+percentage+"%,"+col2+"))";
      els.style.background="-moz-linear-gradient(left center,"+col1+" "+percentage+"%, "+col2+" "+percentage+"%)" ;
      els.style.background="-o-linear-gradient(left,"+col1+" "+percentage+"%, "+col2+" "+percentage+"%)";
      els.style.background= "linear-gradient(to right,"+col1+" "+percentage+"%, "+col2+" "+percentage+"%)";
    }
  }

  // Reset Table - JF 9/27 //
  function resetTable(){
    var main_table = document.getElementById('main_table');
    var main_tbody = document.getElementById('main_tbody');
    var new_tbody = document.createElement('tbody')
    new_tbody.id = 'main_tbody';
    new_tbody.className ='tbody_main'
    main_table.replaceChild(new_tbody, main_tbody);
    initalTable();
  }


    // Allow expand/collapse buttons to a certain "Level" - JF 10/1 //
  function activateLevel(level){
    var i = 1;
    resetTable();

    while (i < level){
      i += 1;
      var elements = [];
      var nodesToExpand = new Set([]);

      for (data of table_data){
        if (data.Level == i){
          elements.push(data);
          nodesToExpand.add(data.ParentNode)
        }
      }
      for (item of nodesToExpand){
        expandNode(item);
      }
    }
  }

  // Render Sparkline Charts - JF - 9/30 //
  function buildTrend(element_id){
    var WIDTH        = 200;
    var HEIGHT       = 30;
    var MARGIN       = { top: 0, right: 0, bottom: 0, left: 0};
    var INNER_WIDTH  = WIDTH - MARGIN.left - MARGIN.right;
    var INNER_HEIGHT = HEIGHT - MARGIN.top - MARGIN.bottom;
    var DATA_COUNT   = 40;
    var data = d3.range(DATA_COUNT).map( d => Math.random() );
    var x    = d3.scaleLinear().domain([0, DATA_COUNT]).range([0, INNER_WIDTH]);
    var y    = d3.scaleLinear().domain([0, 1]).range([INNER_HEIGHT, 0]);
    var svg =  d3.select('#' + element_id).append('svg')

      .attr('width', WIDTH)
      .attr('height', HEIGHT)
      .append('g')
        .attr('transform', 'translate(' + MARGIN.left + ',' + MARGIN.top + ')');

    var line = d3.line()
      .x((d, i) => x(i))
      .y(d => y(d));

    svg.append('path').datum(data)
      .attr('fill', 'none')
      .attr('stroke', '#bbb')
      .attr('stroke-width', 1)
      .attr('d', line);

    svg.append('circle')
      .attr('r', 2)
      .attr('cx', x(0))
      .attr('cy', y(data[0]))
      .attr('fill', 'steelblue');
    svg.append('circle')
      .attr('r', 2)
      .attr('cx', x(DATA_COUNT - 1))
      .attr('cy', y(data[DATA_COUNT - 1]))
      .attr('fill', 'tomato');
  };


  // On Load render table - JF 9/30 //
  $(document).ready(function() {
    resetID();
    initalTable();
  });




</script>




</body>

</html>
