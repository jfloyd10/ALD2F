<!doctype html>
{% load static %}
{% load humanize %}
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Profit & Loss</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- inject:css-->

	  <link rel="stylesheet" type="text/css" href="{% static 'assets/d3site/dc.css' %}"/>

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/bootstrap/bootstrap.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/daterangepicker.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/fontawesome.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/footable.standalone.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/fullcalendar@5.2.0.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/jquery-jvectormap-2.0.5.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/jquery.mCustomScrollbar.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/leaflet.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/line-awesome.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/magnific-popup.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/MarkerCluster.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/MarkerCluster.Default.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/select2.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/slick.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/star-rating-svg.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/trumbowyg.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/vendor_assets/css/wickedpicker.min.css' %}">

    <link rel="stylesheet" href="{% static 'assets/style.css' %}">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.12.0/clusterize.css">

    <style>
    #waterfall {
      width: 100%;
      height: 600px;
    }

     .context-menu {
       position: absolute;
     }
     .menu {
       display: flex;
       flex-direction: column;
       background-color: #fff;
       border-radius: 10px;
       box-shadow: 0 10px 20px rgb(64 64 64 / 5%);
       padding: 10px 0;
     }
     .menu > li > a {
       font: inherit;
       border: 0;
       padding: 10px 30px 10px 15px;
       width: 100%;
       display: flex;
       align-items: center;
       position: relative;
       text-decoration: unset;
       color: #616161;
       font-weight: normal;
       transition: 0.3s linear;
       -webkit-transition: 0.3s linear;
       -moz-transition: 0.3s linear;
       -ms-transition: 0.3s linear;
       -o-transition: 0.3s linear;
     }
     .menu > li > a:hover {
       background:#f1f3f7;
       color: #ff0000;
     }
     .menu > li > a > i {
       padding-right: 10px;
     }
     .menu > li.trash > a:hover {
       color: red;
     }

     .centerrow {
       text-align: center;
       vertical-align: middle;
     }

     .tablesize th {
         position: relative;
     }

     #resizeMe.hide2 tr > *:nth-child(7) {
         display: none;
     }


     .resizer {
         /* Displayed at the right side of column */
         position: absolute;
         top: 0;
         right: 0;
         width: 5px;
         cursor: col-resize;
         user-select: none;
     }

     .negval{
       color: red;
     }

     tr:hover {background-color: rgba(91, 108, 133, .1);}

     .cart { width: 100%; }

     .hasTooltip div {
         display: none;
         color: #000;
         text-decoration: none;
         padding: 3px;
     }

     .hasTooltip:hover div {
         display: block;
         position: absolute;
         left: 50px;
         background-color: #ffffff;

     }


    </style>

    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/favicon.png' %}">
</head>

<body class="layout-light side-menu overlayScroll">



    <div class="Branch STK-search"></div>

    <div class="Branch STK-author-actions"></div>
    <header class="header-top">
        {% include 'navbar.html' %}
    </header>
    <main class="main-content" id ='main_fade'>
      <aside class="sidebar" id='main_sidebar_id' style='margin-top:15px;'>
          <div class="sidebar__menu-group">
              <ul class="sidebar_nav">
                  <li class="menu-title">
                      <span>Group</span>
                  </li>
                  <li class="has-child open">
                      <a href="#" class="active">
                        <select id='group_filter' name='group_filter'>
                          <option value='starter' id='group_filter_default'>Select All</option>
                          {% for g in group_labels %}
                          <option value='{{g}}'>{{g}}</option>
                          {% endfor %}
                        </select>
                      </a>
                  </li>

                  <br>
                  <li class="menu-title">
                      <span>Branch</span>
                  </li>
                  <li class="has-child open">
                      <a href="#" class="active">
                        <select id='branch_filter'>
                          <option value='starter' id='customer_filter_default'>Select All</option>
                          {% for g in branch_labels %}
                          <option value='{{g}}'>{{g}}</option>
                          {% endfor %}
                        </select>
                      </a>
                  </li>

                  <br>
                  <li class="menu-title">
                      <span>Period</span>
                  </li>
                  <li class="has-child open">
                      <a href="#" class="active">
                        <select id='month_filter'>
                          <option value='starter' id='month_filter_default'>Select All</option>
                          {% for g in month_labels %}
                          <option value='{{g}}'>{{g}}</option>
                          {% endfor %}
                        </select>
                      </a>
                  </li>

              </ul>


          </div>
      </aside>

        <div class="contents">
            <div class="container-fluid"><br>


                <div class="row">

                  <div class="col-xxl-12 mb-25">

                      <div class="card border-0">
                          <div class="card-header">
                              <h6>P&L</h6>
                              <div class="card-extra">
                                  <div class="card-tab btn-group atbd-button-group mr-3 nav nav-tabs">
                                      <a class="btn btn-xs btn-white active border" id="f_today-tab" data-toggle="tab" href="#st_matrics-today" role="tab" area-controls="st_matrics" aria-selected="true">Actuals</a>
                                      <a class="btn btn-xs btn-white border" id="f_year-tab" data-toggle="tab" href="#st_matrics-year" role="tab" area-controls="st_matrics" aria-selected="false">Rolling-Avg</a>
                                  </div>
                                  <div class="dropdown dropleft">
                                      <a href="#" role="button" id="Today" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                          <span data-feather="more-horizontal"></span>
                                      </a>
                                      <div class="dropdown-menu" aria-labelledby="Today">
                                          <a class="dropdown-item" href="javascript:exportTableToExcel();">Export</a>
                                          <div class="dropdown-divider"></div>
                                          <a class="dropdown-item" href="{% url 'report_view' %}">View Full Report</a>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="card-body p-0">
                              <div class="tab-content">
                                  <div class="tab-pane fade active show" id="st_matrics-today" role="" aria-labelledby="st_matrics-tab">
                                      <div class="table-responsive">
                                          <table class="table table-bordered table-social" id ='main_pl_table'>
                                              <thead>
                                                  <tr>
                                                      <th scope="col"></th>
                                                      <th scope="col" colspan="5" style='align-center; text-align:center'>August</th>
                                                      <th scope="col" colspan="5" style='align-center; text-align:center'>YTD</th>
                                                  </tr>
                                              </thead>
                                              <tbody id = 'main_table_body'>
                                                  <tr>
                                                      <td>Line</td>
                                                      <td>2021</td>
                                                      <td>2020</td>
                                                      <td>$ Var</td>
                                                      <td>% Var</td>
                                                      <td>%Quota</td>
                                                      <td>2021</td>
                                                      <td>2020</td>
                                                      <td>$ Var</td>
                                                      <td>% Var</td>
                                                      <td>%Quota</td>
                                                  </tr>
                                                  {% for t in pl_line1 %}

                                                  <tr id = "{{t.3}}">

                                                      <td id = "{{t.3}}1-1" class="hasTooltip">{{t.0}}
                                                        {% if t.0 == 'Sales' %}<div id = 'spark1' style='width: 400px;'></div>{% endif %}
                                                        {% if t.0 == 'COGS' %}<div id = 'spark2' style='width: 400px;'></div>{% endif %}
                                                      </td>

                                                      <td id = "{{t.3}}1-2">${{t.6|intcomma}}</td>
                                                      <td id = "{{t.3}}1-3">${{t.7|intcomma}}</td>
                                                      <td id = "{{t.3}}1-4">${{t.9|intcomma}}</td>
                                                      <td id = "{{t.3}}1-5">{{t.11}}%</td>
                                                      <td id = "{{t.3}}1-6">100%</td>
                                                      <td id = "{{t.3}}1-7">${{t.4|intcomma}}</td>
                                                      <td id = "{{t.3}}1-8">${{t.5|intcomma}}</td>
                                                      <td id = "{{t.3}}1-9">${{t.8|intcomma}}</td>
                                                      <td id = "{{t.3}}1-10">{{t.10}}%</td>
                                                      <td id = "{{t.3}}1-11">100%</td>
                                                  </tr>

                                                  {% endfor %}

                                                  <tr id = '3pl'>

                                                      <td id = "3pl3-1">
                                                          <a href=""><b>Gross Profit</b></a>
                                                      </td>
                                                      <td id = "3pl1-2"><b>${{pl_gross_profit.2|intcomma}}</b></td>
                                                      <td id = "3pl1-3"><b>${{pl_gross_profit.3|intcomma}}</b></td>
                                                      <td id = "3pl1-4"><b>${{pl_gross_profit.5|intcomma}}</b></td>
                                                      <td id = "3pl1-5"><b>{{pl_gross_profit.7}}%</b></td>
                                                      <td id = "3pl1-6"><b>100%</b></td>
                                                      <td id = "3pl1-7"><b>${{pl_gross_profit.0|intcomma}}</b></td>
                                                      <td id = "3pl1-8"><b>${{pl_gross_profit.1|intcomma}}</b></td>
                                                      <td id = "3pl1-9"><b>${{pl_gross_profit.4|intcomma}}</b></td>
                                                      <td id = "3pl1-10"><b>{{pl_gross_profit.6}}%</b></td>
                                                      <td id = "3pl1-11"><b>100%</b></td>
                                                  </tr>

                                                  {% for t in pl_line2 %}

                                                  <tr id = "{{t.3}}">

                                                    <td id = "{{t.3}}1-1">
                                                        {{t.0}}
                                                    </td>
                                                    <td id = "{{t.3}}1-2">${{t.6|intcomma}}</td>
                                                    <td id = "{{t.3}}1-3">${{t.7|intcomma}}</td>
                                                    <td id = "{{t.3}}1-4">${{t.9|intcomma}}</td>
                                                    <td id = "{{t.3}}1-5">{{t.11}}%</td>
                                                    <td id = "{{t.3}}1-6">100%</td>
                                                    <td id = "{{t.3}}1-7">${{t.4|intcomma}}</td>
                                                    <td id = "{{t.3}}1-8">${{t.5|intcomma}}</td>
                                                    <td id = "{{t.3}}1-9">${{t.8|intcomma}}</td>
                                                    <td id = "{{t.3}}1-10">{{t.10}}%</td>
                                                    <td id = "{{t.3}}1-11">100%</td>
                                                  </tr>

                                                  {% endfor %}

                                                  <tr id = '7pl'>

                                                      <td id = "7pl1-1">
                                                          <a href=""><b>Net Income</b></a>
                                                      </td>
                                                      <td id = "7pl1-2"><b>${{pl_net_profit.2|intcomma}}</b></td>
                                                      <td id = "7pl1-3"><b>${{pl_net_profit.3|intcomma}}</b></td>
                                                      <td id = "7pl1-4"><b>${{pl_net_profit.5|intcomma}}</b></td>
                                                      <td id = "7pl1-5"><b>{{pl_net_profit.7}}%</b></td>
                                                      <td id = "7pl1-6"><b>100%</b></td>
                                                      <td id = "7pl1-7"><b>${{pl_net_profit.0|intcomma}}</b></td>
                                                      <td id = "7pl1-8"><b>${{pl_net_profit.1|intcomma}}</b></td>
                                                      <td id = "7pl1-9"><b>${{pl_net_profit.4|intcomma}}</b></td>
                                                      <td id = "7pl1-10"><b>{{pl_net_profit.6}}%</b></td>
                                                      <td id = "7pl1-11"><b>100%</b></td>
                                                  </tr>

                                              </tbody>
                                          </table>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                  </div>


              </div>

              <br>

              <div class="row">
                <div class="col-12">
                  <div class="card border-0">
                      <div class="card-header">
                        <h6>P&L Waterfall</h6>
                      </div>
                        <div id='waterfall'></div>
                  </div>

                </div>

              </div>

          </div>

          </div>
        </div>





      <div class="row"><br><br><br><br><br><br><div>

    </div>

  </div>

  <footer class="footer-wrapper">
      <div class="container-fluid">
          <div class="row">
              <div class="col-md-6">
                  <div class="footer-copyright">
                      <p><a href="#">Created by Josh Floyd</a>
                      </p>
                  </div>
              </div>
              <div class="col-md-6">
                  <div class="footer-menu text-right">
                      <ul>
                          <li>
                              <a href="#">About</a>
                          </li>
                          <li>
                              <a href="#">Contact</a>
                          </li>
                      </ul>
                  </div>
                  <!-- ends: .Footer Menu -->
              </div>
          </div>
      </div>
  </footer>
    </main>

    <div id="contextMenu" class="context-menu" style="display: none">
        <ul class="menu" >
            <li class="share"><a href="javascript:userSaveBookmark();"><i class="fa fa-share" aria-hidden="true"></i> Save Bookmark</a></li>
            <li class="link"><a href="#"><i class="fa fa-link" aria-hidden="true"></i> View Bookmarks</a></li>
            <li class="copy"><a href="#"><i class="fa fa-copy" aria-hidden="true"></i> Add Comment</a></li>
            <li class="paste"><a href="#"><i class="fa fa-paste" aria-hidden="true"></i> View Comments</a></li>
            <li class="download"><a href="#"><i class="fa fa-download" aria-hidden="true"></i> Screenshot</a></li>
        </ul>
    </div>


    <div id="overlayer">
        <span class="loader-overlay">
            <div class="atbd-spin-dots spin-lg">
                <span class="spin-dot badge-dot dot-primary"></span>
                <span class="spin-dot badge-dot dot-primary"></span>
                <span class="spin-dot badge-dot dot-primary"></span>
                <span class="spin-dot badge-dot dot-primary"></span>
            </div>
        </span>
    </div>


    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDduF2tLXicDEPDMAtC6-NLOekX0A5vlnY"></script>
    <!-- inject:js-->
    <script src="{% static 'assets/vendor_assets/js/jquery/jquery-3.5.1.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery/jquery-ui.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/bootstrap/popper.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/bootstrap/bootstrap.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/moment/moment.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/accordion.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/autoComplete.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/Chart.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/charts.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/daterangepicker.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/drawer.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/dynamicBadge.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/dynamicCheckbox.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/feather.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/footable.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/fullcalendar@5.2.0.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/google-chart.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery-jvectormap-2.0.5.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery-jvectormap-world-mill-en.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.countdown.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.filterizr.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.magnific-popup.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.mCustomScrollbar.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.peity.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/jquery.star-rating-svg.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/leaflet.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/leaflet.markercluster.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/loader.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/message.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/moment.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/muuri.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/notification.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/popover.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/select2.full.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/slick.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/trumbowyg.base64.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/trumbowyg.min.js' %}"></script>
    <script src="{% static 'assets/vendor_assets/js/wickedpicker.min.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/drag-drop.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/footable.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/full-calendar.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/googlemap-init.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/icon-loader.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/jvectormap-init.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/leaflet-init.js' %}"></script>
    <script src="{% static 'assets/theme_assets/js/main.js' %}"></script>


    <script type="text/javascript" src="{% static 'assets/d3site/d3.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/crossfilter.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/dc.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/axis.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/margin-mixin.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/cap-mixin.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/d3site/dc.datatables.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>

    <!-- Resources -->
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/plugins/regression.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/plugins/rangeSelector.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/plugins/sunburst.js"></script>
    <script src="//www.amcharts.com/lib/4/themes/microchart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.12.0/clusterize.min.js"></script>




<script type="text/javascript">

    //Table Data
    var table_data = {{pl_table|safe}};
    var pl_line1 = {{pl_line1|safe}};
    var pl_line2 = {{pl_line2|safe}};

    //Selectors
    var group_select = ['starter'];
    var branch_select = ['starter'];
    var month_select = ['starter'];

    //Labels
    var group_labels = {{group_labels|safe}};
    var branch_labels = {{branch_labels|safe}};
    var month_labels = {{month_labels|safe}};

    //Data
    var responseData = null;
    var waterfallChart = null;

    var spark1 = null;
    var spark2 = null;
    var spark3 = null;
    var spark4 = null;


    function clearAllSelections(){
      $('#group_filter').val('starter');
      $('#group_filter').trigger('change');
      $('#branch_filter').val('starter');
      $('#branch_filter').trigger('change');
      $('#month_filter').val('starter');
      $('#month_filter').trigger('change');
    };

    function clearAllandRefresh(){
      $('#group_filter').val('starter');
      $('#group_filter').trigger('change');
      $('#branch_filter').val('starter');
      $('#branch_filter').trigger('change');
      $('#month_filter').val('starter');
      $('#month_filter').trigger('change');
      industry_select = ['starter'];

      updateDataAll();
      redrawCanvas();
      rebuildCharts();
      updateLabels();
      updateFilters2();
    };


  function updateLabels(){
  };

  function updateFilters2(){
  };

  function updateDataAll(){

    $.ajax({
        url: '{% url "gather_data_gl" %}',
        data: {

          //Filters
          'group_select': group_select,
          'branch_select': branch_select,
          'month_select':month_select,

        },

        dataType: 'json',
          success: function (data) {
              if (data.is_taken) {

                  table_data = data.main_data

                  //select labels
                  responseData = data
                  updateLabels();
                  updateFilters2();

                  pl_line1 = data.pl_line1;
                  pl_line2 = data.pl_line2;
                  waterfall = pl_line1;
                  waterfall2 = pl_line2;
                  pl_gross_profit = data.pl_gross_profit;
                  pl_net_profit = data.pl_net_profit;

                  updateTable();
                  waterfallChart.data = updateWaterfall();

                  colorCells();

              }
          }
    });
};


$(document).ready(function(){
  // Initialize select2
  $("#group_filter").select2();
  $("#branch_filter").select2();
  $("#month_filter").select2();
});


//Listeners
$("#group_filter").change(function () {
  group_select = $("#group_filter").val();
  updateDataAll();
});

$("#branch_filter").change(function () {
  branch_select = $("#branch_filter").val();
  updateDataAll();
});

$("#month_filter").change(function () {
  month_select = $("#month_filter").val();
  updateDataAll();
});

</script>

<script>

  //Context Menu
   document.onclick = hideMenu;
   document.oncontextmenu = rightClick;

    function hideMenu() {
        document.getElementById("contextMenu").style.display = "none"
        $("#main_fade").fadeTo("fast", 1);
    }

    function rightClick(e) {
    $("#main_fade").fadeTo("slow", 0.4);


        e.preventDefault();

        if (document.getElementById("contextMenu") .style.display == "block"){
            hideMenu();

        }else{
            var menu = document.getElementById("contextMenu")
            menu.style.display = 'block';
            menu.style.left = e.pageX + "px";
            menu.style.top = e.pageY + "px";
        }

  }

function slugify(text)
{
  return text.toString()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-\-+/g, '-')
    .replace(/^-+/, '')
    .replace(/-+$/, '');
};

function userSaveBookmark(){
  console.log('Called');
  $.ajax({
      url: '{% url "save_bookmark" %}',
      data: {

        //Filters
        'group_select': group_select,
        'branch_select': branch_select,
        'month_select':month_select,
        'page': 'ledger',

      },

      dataType: 'json',
        success: function (data) {
            if (data.success == 1) {
              Swal.fire({
                icon: 'success',
                title: 'Saved',
                text: 'Bookmark Saved Successfully',
                confirmButtonColor: '#00c247',
              });
            } else {
              Swal.fire({
                icon: 'danger',
                title: 'Failed',
                text: 'Bookmark Save Failed',
                confirmButtonColor: '#db291d',
              });
            }
        }
  })
};


var all_pre_filters = null;

var formatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  maximumFractionDigits: 0
});

function updateTable(){

  var sales = pl_line1[0];
  var cogs = pl_line1[1];

  var salaries = pl_line2[0];
  var commissions = pl_line2[1];
  var other_opex = pl_line2[2];

  document.getElementById('1pl1-2').innerHTML = formatter.format(sales[6]);
  document.getElementById('1pl1-3').innerHTML = formatter.format(sales[7]);
  document.getElementById('1pl1-4').innerHTML = formatter.format(sales[9]);
  document.getElementById('1pl1-5').innerHTML = formatter.format(sales[11]);
  document.getElementById('1pl1-7').innerHTML = formatter.format(sales[4]);
  document.getElementById('1pl1-8').innerHTML = formatter.format(sales[5]);
  document.getElementById('1pl1-9').innerHTML = formatter.format(sales[8]);
  document.getElementById('1pl1-10').innerHTML = formatter.format(sales[10]);

  document.getElementById('2pl1-2').innerHTML = formatter.format(cogs[6]);
  document.getElementById('2pl1-3').innerHTML = formatter.format(cogs[7]);
  document.getElementById('2pl1-4').innerHTML = formatter.format(cogs[9]);
  document.getElementById('2pl1-5').innerHTML = formatter.format(cogs[11]);
  document.getElementById('2pl1-7').innerHTML = formatter.format(cogs[4]);
  document.getElementById('2pl1-8').innerHTML = formatter.format(cogs[5]);
  document.getElementById('2pl1-9').innerHTML = formatter.format(cogs[8]);
  document.getElementById('2pl1-10').innerHTML = formatter.format(cogs[10]);

  document.getElementById('4pl1-2').innerHTML = formatter.format(salaries[6]);
  document.getElementById('4pl1-3').innerHTML = formatter.format(salaries[7]);
  document.getElementById('4pl1-4').innerHTML = formatter.format(salaries[9]);
  document.getElementById('4pl1-5').innerHTML = formatter.format(salaries[11]);
  document.getElementById('4pl1-7').innerHTML = formatter.format(salaries[4]);
  document.getElementById('4pl1-8').innerHTML = formatter.format(salaries[5]);
  document.getElementById('4pl1-9').innerHTML = formatter.format(salaries[8]);
  document.getElementById('4pl1-10').innerHTML = formatter.format(salaries[10]);

  document.getElementById('5pl1-2').innerHTML = formatter.format(commissions[6]);
  document.getElementById('5pl1-3').innerHTML = formatter.format(commissions[7]);
  document.getElementById('5pl1-4').innerHTML = formatter.format(commissions[9]);
  document.getElementById('5pl1-5').innerHTML = formatter.format(commissions[11]);
  document.getElementById('5pl1-7').innerHTML = formatter.format(commissions[4]);
  document.getElementById('5pl1-8').innerHTML = formatter.format(commissions[5]);
  document.getElementById('5pl1-9').innerHTML = formatter.format(commissions[8]);
  document.getElementById('5pl1-10').innerHTML = formatter.format(commissions[10]);

  document.getElementById('6pl1-2').innerHTML = formatter.format(other_opex[6]);
  document.getElementById('6pl1-3').innerHTML = formatter.format(other_opex[7]);
  document.getElementById('6pl1-4').innerHTML = formatter.format(other_opex[9]);
  document.getElementById('6pl1-5').innerHTML = formatter.format(other_opex[11]);
  document.getElementById('6pl1-7').innerHTML = formatter.format(other_opex[4]);
  document.getElementById('6pl1-8').innerHTML = formatter.format(other_opex[5]);
  document.getElementById('6pl1-9').innerHTML = formatter.format(other_opex[8]);
  document.getElementById('6pl1-10').innerHTML = formatter.format(other_opex[10]);

  var gross_profit = pl_gross_profit;
  var net_profit = pl_net_profit;

  document.getElementById('3pl1-2').innerHTML = formatter.format(gross_profit[2]);
  document.getElementById('3pl1-2').style.fontWeight = 'bold';
  document.getElementById('3pl1-3').innerHTML = formatter.format(gross_profit[3]);
  document.getElementById('3pl1-3').style.fontWeight = 'bold';
  document.getElementById('3pl1-4').innerHTML = formatter.format(gross_profit[5]);
  document.getElementById('3pl1-4').style.fontWeight = 'bold';
  document.getElementById('3pl1-5').innerHTML = gross_profit[7] + '%';
  document.getElementById('3pl1-5').style.fontWeight = 'bold';
  document.getElementById('3pl1-7').innerHTML = formatter.format(gross_profit[0]);
  document.getElementById('3pl1-7').style.fontWeight = 'bold';
  document.getElementById('3pl1-8').innerHTML = formatter.format(gross_profit[1]);
  document.getElementById('3pl1-8').style.fontWeight = 'bold';
  document.getElementById('3pl1-9').innerHTML = formatter.format(gross_profit[4]);
  document.getElementById('3pl1-9').style.fontWeight = 'bold';
  document.getElementById('3pl1-10').innerHTML = gross_profit[6] + '%';
  document.getElementById('3pl1-10').style.fontWeight = 'bold';

  document.getElementById('7pl1-2').innerHTML = formatter.format(net_profit[2]);
  document.getElementById('7pl1-2').style.fontWeight = 'bold';
  document.getElementById('7pl1-3').innerHTML = formatter.format(net_profit[3]);
  document.getElementById('7pl1-3').style.fontWeight = 'bold';
  document.getElementById('7pl1-4').innerHTML = formatter.format(net_profit[5]);
  document.getElementById('7pl1-4').style.fontWeight = 'bold';
  document.getElementById('7pl1-5').innerHTML = net_profit[7] + '%';
  document.getElementById('7pl1-5').style.fontWeight = 'bold';
  document.getElementById('7pl1-7').innerHTML = formatter.format(net_profit[0]);
  document.getElementById('7pl1-7').style.fontWeight = 'bold';
  document.getElementById('7pl1-8').innerHTML = formatter.format(net_profit[1]);
  document.getElementById('7pl1-8').style.fontWeight = 'bold';
  document.getElementById('7pl1-9').innerHTML = formatter.format(net_profit[4]);
  document.getElementById('7pl1-9').style.fontWeight = 'bold';
  document.getElementById('7pl1-10').innerHTML = net_profit[6] + '%';
  document.getElementById('7pl1-10').style.fontWeight = 'bold';


};

var waterfall = {{pl_line1|safe}};
var waterfall2 = {{pl_line2|safe}};

am4core.ready(function() {
am4core.useTheme(am4themes_animated);
var chart = am4core.create("waterfall", am4charts.XYChart);
chart.hiddenState.properties.opacity = 0;
chart.colors.list = [
am4core.color("#2474a6"),
am4core.color("#ff0000"),
am4core.color("#919191"),
];
chart.data = [ {
  category: "Net revenue",
  value: waterfall[0][6],
  open: 0,
  stepValue: waterfall[0][6],
  color: chart.colors.getIndex(0),
  displayValue: waterfall[0][6]
}, {
  category: "COGS",
  value: waterfall[0][6] - waterfall[1][6],
  open: waterfall[0][6],
  stepValue: waterfall[0][6]- waterfall[1][6],
  color: chart.colors.getIndex(1),
  displayValue: waterfall[1][6]
},
{
  category: "Gross Profit",
  value: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6],
  open: 0,
  stepValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6],
  color: chart.colors.getIndex(2),
  displayValue: waterfall2[0][6]
},
{
  category: "Salaries",
  value: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6],
  open: waterfall[0][6] - waterfall[1][6],
  stepValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6],
  color: chart.colors.getIndex(1),
  displayValue: waterfall2[0][6]
}, {
  category: "Commissions",
  value: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6],
  open: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6],
  stepValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6],
  color: chart.colors.getIndex(1),
  displayValue: waterfall2[1][6]
}, {
  category: "Other OPEX",
  value: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6] - waterfall2[2][6],
  open: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6],
  stepValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6] - waterfall2[2][6],
  color: chart.colors.getIndex(1),
  displayValue: waterfall2[2][6]
}, {
  category: "Net Income",
  value: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6] - waterfall2[2][6],
  open: 0,
  stepValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6] - waterfall2[2][6],
  color: chart.colors.getIndex(2),
  displayValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6] - waterfall2[2][6]
} ];

var categoryAxis = chart.xAxes.push(new am4charts.CategoryAxis());
categoryAxis.dataFields.category = "category";
categoryAxis.renderer.minGridDistance = 40;
var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
var columnSeries = chart.series.push(new am4charts.ColumnSeries());
columnSeries.dataFields.categoryX = "category";
columnSeries.dataFields.valueY = "value";
columnSeries.dataFields.openValueY = "open";
columnSeries.fillOpacity = 0.95;
columnSeries.sequencedInterpolation = true;
columnSeries.interpolationDuration = 1500;
var columnTemplate = columnSeries.columns.template;
columnTemplate.strokeOpacity = 0;
columnTemplate.propertyFields.fill = "color";
var label = columnTemplate.createChild(am4core.Label);
label.text = "{displayValue.formatNumber('$#,## a')}";
label.align = "center";
label.valign = "middle";
label.fill = am4core.color("#ffffff");
var stepSeries = chart.series.push(new am4charts.StepLineSeries());
stepSeries.dataFields.categoryX = "category";
stepSeries.dataFields.valueY = "stepValue";
stepSeries.noRisers = true;
stepSeries.stroke = new am4core.InterfaceColorSet().getFor("alternativeBackground");
stepSeries.strokeDasharray = "3,3";
stepSeries.interpolationDuration = 2000;
stepSeries.sequencedInterpolation = true;
stepSeries.startLocation = 0.9;
stepSeries.endLocation = 1.1;
chart.cursor = new am4charts.XYCursor();
waterfallChart = chart;
});


function updateWaterfall(){
  var chartData = [ {
    category: "Net revenue",
    value: waterfall[0][6],
    open: 0,
    stepValue: waterfall[0][6],
    color: waterfallChart.colors.getIndex(0),
    displayValue: waterfall[0][6]
  }, {
    category: "COGS",
    value: waterfall[0][6] - waterfall[1][6],
    open: waterfall[0][6],
    stepValue: waterfall[0][6]- waterfall[1][6],
    color: waterfallChart.colors.getIndex(1),
    displayValue: waterfall[1][6]
  },
  {
    category: "Gross Profit",
    value: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6],
    open: 0,
    stepValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6],
    color: waterfallChart.colors.getIndex(2),
    displayValue: waterfall2[0][6]
  },
  {
    category: "Salaries",
    value: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6],
    open: waterfall[0][6] - waterfall[1][6],
    stepValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6],
    color: waterfallChart.colors.getIndex(1),
    displayValue: waterfall2[0][6]
  }, {
    category: "Commissions",
    value: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6],
    open: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6],
    stepValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6],
    color: waterfallChart.colors.getIndex(1),
    displayValue: waterfall2[1][6]
  }, {
    category: "Other OPEX",
    value: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6] - waterfall2[2][6],
    open: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6],
    stepValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6] - waterfall2[2][6],
    color: waterfallChart.colors.getIndex(1),
    displayValue: waterfall2[2][6]
  }, {
    category: "Net Income",
    value: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6] - waterfall2[2][6],
    open: 0,
    stepValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6] - waterfall2[2][6],
    color: waterfallChart.colors.getIndex(2),
    displayValue: waterfall[0][6] - waterfall[1][6] - waterfall2[0][6] - waterfall2[1][6] - waterfall2[2][6]
  }];
  return chartData;
}



// data for the sparklines that appear below header area
var sparklineData = [47, 45, 54, 38, 56, 24, 65, 31, 37, 39, 62, 51, 35, 41, 35, 27, 93, 53, 61, 27, 54, 43, 19, 46];

function randomIntFromInterval(min, max) { // min and max included
  return Math.floor(Math.random() * (max - min + 1) + min)
}

function generateSparkData(int){
  var spark_data = [];

  for (i=0; i < 26; i++){
    spark_data.push(randomIntFromInterval(int,1000))
  }
  return spark_data
}



$( document ).ready(function() {
  var colorPalette = ['#00D8B6', '#008FFB', '#FEB019', '#FF4560', '#775DD0']


  var colors = ['#325082'];
  var dataColors = $("#spark1").data('colors');
  if (dataColors) {
      colors = dataColors.split(",");
  }
  var spark1 = {
      chart: {
          type: 'area',
          height: 100,
          sparkline: {
              enabled: true
          },
      },
      stroke: {
          width: 2,
          curve: 'smooth'
      },
      fill: {
          opacity: 0.5,
      },
      series: [{
          name: 'Sales',
          data: generateSparkData(700)
      }],
      yaxis: {
          min: 600
      },
      tooltip: {
          enabled: false,
      },
      colors: colors,
      title: {
          text: 'Sales',
          offsetX: 10,
          offsetY: 0,
          style: {
            fontSize:  '12px',
            fontFamily:  'Sans-serif',
            color:  '#525252'
          }
      }

  }

  spark1 = new ApexCharts(document.querySelector("#spark1"), spark1)
  spark1.render();

  var colors = ['#97aebd'];
  var dataColors = $("#spark2").data('colors');
  if (dataColors) {
      colors = dataColors.split(",");
  }
  var spark2 = {
      chart: {
          type: 'area',
          height: 100,
          sparkline: {
              enabled: true
          },
      },
      stroke: {
          width: 2,
          curve: 'smooth'
      },
      fill: {
          opacity: 0.2,
      },
      series: [{
          name: 'COGS',
          data: generateSparkData(600)
      }],
      yaxis: {
          min: 200
      },
      colors: colors,
      title: {
          text: 'COGS',
          offsetX: 10,
          style: {
            fontSize:  '12px',
            fontFamily:  'Sans-serif',
            color:  '#525252'
          },
      },
      tooltip: {
          enabled: false,
      },

  }

  spark2 = new ApexCharts(document.querySelector("#spark2"), spark2)
  spark2.render();

});


function formatPercentSales(element, percentage){
    var col1="rgba(0, 224, 67, .15)";
    var col2="#ffF";
    var els = document.getElementById(element);
    var percentage = percentage;
    els.style.background="-webkit-gradient(linear, left top,right top, color-stop("+percentage+"%,"+col1+"), color-stop("+percentage+"%,"+col2+"))";
    els.style.background="-moz-linear-gradient(left center,"+col1+" "+percentage+"%, "+col2+" "+percentage+"%)" ;
    els.style.background="-o-linear-gradient(left,"+col1+" "+percentage+"%, "+col2+" "+percentage+"%)";
    els.style.background= "linear-gradient(to right,"+col1+" "+percentage+"%, "+col2+" "+percentage+"%)" ;
}

function colorCells(){
    //Format %Sales

    //MTD
    formatPercentSales('2pl1-2', (pl_line1[1][6] / pl_line1[0][6])*100);
    formatPercentSales('4pl1-2', (pl_line2[0][6] / pl_line1[0][6])*100);
    formatPercentSales('5pl1-2', (pl_line2[1][6] / pl_line1[0][6])*100);
    formatPercentSales('6pl1-2', (pl_line2[2][6] / pl_line1[0][6])*100);

    //YTD
    formatPercentSales('2pl1-7', (pl_line1[1][4] / pl_line1[0][4])*100);
    formatPercentSales('4pl1-7', (pl_line2[0][4] / pl_line1[0][4])*100);
    formatPercentSales('5pl1-7', (pl_line2[1][4] / pl_line1[0][4])*100);
    formatPercentSales('6pl1-7', (pl_line2[2][4] / pl_line1[0][4])*100);

    //formatPercentSales('3pl1-2', ((pl_line1[0][6] - pl_line1[1][6])/pl_line1[0][6])*100);
    //formatPercentSales('7pl1-2', ((pl_line1[0][6] - pl_line1[1][6] - pl_line2[0][6] - pl_line2[1][6] - pl_line2[2][6])/pl_line1[0][6])*100);

}

function exportTableToExcel(){
    filename = 'dataexport'
    var downloadLink;
    var dataType = 'application/vnd.ms-excel';
    var tableSelect = document.getElementById('main_pl_table');
    var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
    filename = filename?filename+'.xls':'excel_data.xlsx';
    downloadLink = document.createElement("a");
    document.body.appendChild(downloadLink);
    if(navigator.msSaveOrOpenBlob){
        var blob = new Blob(['\ufeff', tableHTML], {
            type: dataType
        });
        navigator.msSaveOrOpenBlob( blob, filename);
    }else{
        downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
        downloadLink.download = filename;
        downloadLink.click();
    }
}



$( document ).ready(function() {
    colorCells();
});



</script>




</body>

</html>
